<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Campus Map – Highlight by Number (Loras)</title>
<style>
  :root { --purple:#442D7D; --gold:#D1B888; --gray:#e0e0e0; --ink:#222; }
  body{ font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; margin:16px; color:var(--ink); }
  .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  .controls input[type=text]{ padding:8px; border:1px solid #bbb; border-radius:6px; width:140px; }
  .controls button{ padding:8px 12px; border:0; border-radius:6px; cursor:pointer; }
  #goBtn{ background:var(--purple); color:#fff; }
  #clearBtn{ background:#e9e6ef; color:#2c2461; }
  .wrap{ border:1px solid var(--gray); width:100%; max-width:1400px; background:#fafafa; }
  svg{ width:100%; height:auto; display:block; }
  .highlight{ fill:var(--gold) !important; stroke:var(--purple) !important; stroke-width:3 !important; filter: drop-shadow(0 0 6px rgba(68,45,125,.6)); }
  .status{ margin-top:8px; min-height:1.2em; color:#444; }
  .sr-only{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; border:0; padding:0; margin:-1px; }
  .note{ color:#555; margin:6px 0 12px; }
</style>
</head>
<body>
<h1 style="font-size:1.25rem;margin:0 0 8px">Loras Campus Map – Highlight by Number</h1>
<p class="note">
  Place this file <code>CampusMap.html</code> in the same folder as <code>map.png</code> and <code>loras-campus-overlay.svg</code>.
  Open it from a web server (SharePoint/Experience or any static host). Opening as <code>file:///</code> works in many browsers,
  but if the overlay doesn’t appear, host the files so the browser can load the SVG.
</p>

<div class="controls" aria-label="Highlight a building by number">
  <label for="bnum">Building #</label>
  <input id="bnum" type="text" list="suggest" placeholder="1, 12, 14A" inputmode="text" />
  <datalist id="suggest"></datalist>
  <button id="goBtn" type="button">Highlight</button>
  <button id="clearBtn" type="button">Clear</button>
</div>

<div class="wrap">
  <!-- SVG viewBox will be set to the PNG's natural size at runtime -->
  <svg id="mapSvg" role="img" aria-label="Loras College campus map">
    <title>Loras College Campus Map</title>
    <image id="baseImg" x="0" y="0" href="" width="100" height="100" preserveAspectRatio="xMidYMid meet" />
    <!-- Overlay nodes will be inserted here -->
    <g id="overlayRoot"></g>
  </svg>
</div>

<div id="status" class="status" role="status" aria-live="polite"></div>

<script>
(function(){
  const MAP_SRC     = 'map.png';
  const OVERLAY_SRC = 'loras-campus-overlay.svg';

  const svg   = document.getElementById('mapSvg');
  const img   = document.getElementById('baseImg');
  const host  = document.getElementById('overlayRoot');
  const bnum  = document.getElementById('bnum');
  const goBtn = document.getElementById('goBtn');
  const clrBtn= document.getElementById('clearBtn');
  const suggest = document.getElementById('suggest');
  const statusEl= document.getElementById('status');

  function setStatus(m, err){ statusEl.textContent = m || ''; statusEl.style.color = err ? '#b00020' : '#444'; }
  function normVal(s){ s = String(s||'').trim().toUpperCase(); return /^[0-9]+[A-Z]?$/.test(s) ? s : null; }
  function clearHighlights(){ svg.querySelectorAll('.highlight').forEach(el=>el.classList.remove('highlight')); setStatus('Cleared.'); }
  function highlight(val){
    const key = normVal(val); if(!key){ setStatus('Enter 1, 12, or 14A.', true); return; }
    clearHighlights();
    const id = 'marker-'+key; const g = svg.querySelector('#'+CSS.escape(id));
    if(!g){ setStatus(`No marker found for ${key}.`, true); return; }
    (g.querySelector('circle, ellipse, path, rect, polygon')||g).classList.add('highlight');
    g.setAttribute('tabindex','-1'); g.focus?.({preventScroll:true});
    setStatus(`Highlighted ${key}.`);
  }
  goBtn.addEventListener('click', ()=>highlight(bnum.value));
  bnum.addEventListener('keydown', e=>{ if(e.key==='Enter') highlight(bnum.value); });
  clrBtn.addEventListener('click', ()=>{ bnum.value=''; clearHighlights(); });

  // 1) Load base PNG, set SVG coordinate system to its natural pixels
  function loadBase(){
    return new Promise((resolve, reject)=>{
      const probe = new Image();
      probe.onload = ()=>{ svg.setAttribute('viewBox', `0 0 ${probe.naturalWidth} ${probe.naturalHeight}`);
                           img.setAttribute('href', MAP_SRC);
                           img.setAttribute('width', probe.naturalWidth);
                           img.setAttribute('height', probe.naturalHeight);
                           resolve({w:probe.naturalWidth,h:probe.naturalHeight}); };
      probe.onerror = ()=> reject(new Error('Could not load map.png'));
      probe.src = MAP_SRC + '?v=' + Date.now();
    });
  }

  // 2) Load overlay (works for http/https). If blocked (e.g., file:///), auto-fallback via <object>.
  async function loadOverlayHttp(png){
    const r = await fetch(OVERLAY_SRC + '?v=' + Date.now());
    if(!r.ok) throw new Error('Overlay fetch failed');
    const txt = await r.text();
    const doc = new DOMParser().parseFromString(txt, 'image/svg+xml');
    importOverlaySvg(doc.documentElement, png);
  }

  function importOverlaySvg(ovSvg, png){
    // Determine overlay coordinate space
    let [ox, oy, ow, oh] = [0,0,1000,1000];
    const vb = ovSvg.getAttribute('viewBox');
    if(vb){ const p = vb.trim().split(/\s+|,/).map(Number); if(p.length===4 && p.every(Number.isFinite)) [ox,oy,ow,oh] = p; }
    else {
      const w = parseFloat(ovSvg.getAttribute('width')); const h = parseFloat(ovSvg.getAttribute('height'));
      if(Number.isFinite(w) && Number.isFinite(h)) { ow=w; oh=h; }
    }

    const sx = png.w / ow, sy = png.h / oh;
    const wrapper = document.createElementNS('http://www.w3.org/2000/svg','g');
    wrapper.setAttribute('id','overlay-root');
    wrapper.setAttribute('transform', `translate(${-ox*sx}, ${-oy*sy}) scale(${sx}, ${sy})`);

    const nodes = ovSvg.querySelectorAll('[id^="marker-"]');
    if(nodes.length){ nodes.forEach(n=> wrapper.appendChild(n.cloneNode(true))); }
    else { wrapper.innerHTML = ovSvg.innerHTML; }

    host.appendChild(wrapper);

    // Build datalist suggestions
    const ids = Array.from(svg.querySelectorAll('[id^="marker-"]')).map(n=> n.id.replace(/^marker-/,''));
    const unique = Array.from(new Set(ids)).sort((a,b)=>{
      const rx=/^([0-9]+)([A-Z]?)$/; const ma=a.match(rx), mb=b.match(rx);
      if(ma&&mb){ const na=+ma[1], nb=+mb[1]; if(na!==nb) return na-nb; return (ma[2]||'').localeCompare(mb[2]||''); }
      return a.localeCompare(b);
    });
    suggest.innerHTML = unique.map(v=>`<option value="${v}"></option>`).join('');
  }

  function loadOverlayViaObject(png){
    return new Promise((resolve, reject)=>{
      const obj = document.createElement('object');
      obj.type = 'image/svg+xml';
      obj.data = OVERLAY_SRC + '?v=' + Date.now();
      obj.style.display = 'none';
      obj.onload = ()=>{
        try{
          const doc = obj.contentDocument; const ovSvg = doc && doc.querySelector('svg');
          if(!ovSvg) throw new Error('Overlay <svg> not found');
          importOverlaySvg(ovSvg, png); obj.remove(); resolve();
        }catch(e){ obj.remove(); reject(e); }
      };
      obj.onerror = ()=>{ obj.remove(); reject(new Error('Overlay object load failed')); };
      document.body.appendChild(obj);
    });
  }

  (async function init(){
    try{
      const png = await loadBase();
      try {
        await loadOverlayHttp(png); // works on http/https
      } catch { 
        // fallback that works on file:/// in most browsers
        await loadOverlayViaObject(png);
      }
      const usp = new URLSearchParams(location.search);
      const initial = usp.get('b') || usp.get('building');
      if(initial){ bnum.value = String(initial).toUpperCase(); highlight(bnum.value); }
      else setStatus('Ready. Type a number (e.g., 12) and click Highlight.');
    } catch(e){ setStatus(e.message + ' — Check that map.png and loras-campus-overlay.svg are next to this file.', true); }
  })();
})();
</script>
</body>
</html>
