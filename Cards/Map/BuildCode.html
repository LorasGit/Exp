<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loras Campus Map – Highlight by Number (Embedded Image)</title>
<style>
  :root { --purple:#442D7D; --gold:#D1B888; --gray:#ddd; --ink:#333; }

  body{ font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; margin:16px; color:var(--ink); }

  .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  .controls input[type=text]{ padding:8px; border:1px solid #bbb; border-radius:6px; width:140px; }
  .controls button{ padding:8px 12px; border:0; border-radius:6px; cursor:pointer; }
  #goBtn{ background:var(--purple); color:#fff; }
  #clearBtn, #placeBtn, #undoBtn, #dlSvgBtn, #dlJsonBtn{ background:#e9e6ef; color:#2c2461; }

  .wrap{ border:1px solid var(--gray); width:100%; max-width:1400px; background:#fafafa; }
  /* The SVG scales responsively; internal coordinates remain in image pixels */
  svg{ width:100%; height:auto; display:block; }

  /* Marker visuals */
  .marker circle{ fill:#fff; stroke:#000; stroke-width:1.25; }
  /* Highlight style */
  .highlight{ fill:var(--gold) !important; stroke:var(--purple) !important; stroke-width:3 !important;
              filter:drop-shadow(0 0 6px rgba(68,45,125,.6)) }

  /* Placing mode cursor */
  .placing{ cursor: crosshair; }

  .status{ margin-top:8px; min-height:1.2em; color:#444; }
  .hint{ color:#555; margin:6px 0 12px; }

  /* Click ripple feedback */
  .ripple{ fill:rgba(68,45,125,.12); stroke:rgba(68,45,125,.45); stroke-width:2; animation:r .35s ease-out both }
  @keyframes r{ from{ r:0; opacity:.9 } to{ r:26; opacity:0 } }
</style>
</head>
<body>

<h1 style="font-size:1.25rem;margin:0 0 8px">Loras Campus Map – Highlight by Number</h1>

<div class="controls" aria-label="Search / editing">
  <label for="bnum">Building #</label>
  <input id="bnum" type="text" placeholder="1, 12 or 14A" inputmode="text" />
  <button id="goBtn" type="button">Highlight</button>
  <button id="clearBtn" type="button">Clear</button>

  <!-- edit (one-time placement) -->
  <button id="placeBtn" type="button" title="Toggle placing mode">Place mode</button>
  <button id="undoBtn" type="button" title="Remove the last placed marker">Undo</button>

  <!-- optional exports -->
  <button id="dlSvgBtn" type="button" title="Download overlay SVG">Download Overlay SVG</button>
  <button id="dlJsonBtn" type="button" title="Download mapping JSON">Download mapping.json</button>
</div>

<div class="hint">
  This file embeds <code>map.png</code> <em>inside</em> the SVG, so clicks align perfectly.  
  Type a number → <b>Place mode</b> → click on the matching circle. Repeat for all 30.
</div>

<div class="wrap">
  <!-- The SVG viewBox will be set dynamically to the image's natural size (W×H) -->
  <svg id="campusSvg" viewBox="0 0 100 100" role="img" aria-label="Loras College campus map">
    <!-- Base image (set after it loads to get W/H) -->
    <image id="baseImg" x="0" y="0" href="" width="100" height="100" preserveAspectRatio="xMidYMid meet" />
    <!-- Markers go here; each marker is a <g id="marker-##"> with a <circle> -->
    <g id="markers"></g>
  </svg>
</div>

<div id="status" class="status" role="status" aria-live="polite"></div>

<script>
(function(){
  const svg = document.getElementById('campusSvg');
  const img = document.getElementById('baseImg');
  const markersG = document.getElementById('markers');

  const bnum = document.getElementById('bnum');
  const goBtn = document.getElementById('goBtn');
  const clearBtn = document.getElementById('clearBtn');

  const placeBtn = document.getElementById('placeBtn');
  const undoBtn  = document.getElementById('undoBtn');
  const dlSvgBtn = document.getElementById('dlSvgBtn');
  const dlJsonBtn = document.getElementById('dlJsonBtn');
  const statusEl = document.getElementById('status');

  let placing = false;
  let lastPlaced = null;
  const placed = []; // {id, x, y, r}

  function setStatus(msg, isErr=false){
    statusEl.textContent = msg || '';
    statusEl.style.color = isErr ? '#b00020' : '#444';
  }

  function sanitizeNumber(raw){
    const s = String(raw||'').trim().toUpperCase();
    return /^[0-9]+[A-Z]?$/.test(s) ? s : null;
  }

  // Convert client click to SVG user units using CTM (robust at any scale)
  function clientToSvg(evt){
    const pt = svg.createSVGPoint();
    pt.x = evt.clientX; pt.y = evt.clientY;
    const inv = svg.getScreenCTM().inverse();
    return pt.matrixTransform(inv);
  }

  function rippleAt(x, y){
    const r = document.createElementNS('http://www.w3.org/2000/svg','circle');
    r.setAttribute('cx', x); r.setAttribute('cy', y); r.setAttribute('r', 0);
    r.classList.add('ripple');
    svg.appendChild(r);
    r.addEventListener('animationend', ()=> r.remove());
  }

  function createMarker(id, x, y, r=18){
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('id', id);
    g.classList.add('marker');
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx', x.toFixed(2));
    c.setAttribute('cy', y.toFixed(2));
    c.setAttribute('r', r);
    g.appendChild(c);
    markersG.appendChild(g);
    return g;
  }

  function clearHighlights(){
    svg.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
    setStatus('Cleared.');
  }

  function highlight(val){
    const key = sanitizeNumber(val);
    if (!key){ setStatus('Enter a valid number like 1, 12, or 14A.', true); return; }
    clearHighlights();
    const g = svg.querySelector('#' + CSS.escape('marker-' + key));
    if (!g){ setStatus(`No marker found for ${key}.`, true); return; }
    const circle = g.querySelector('circle') || g;
    circle.classList.add('highlight');
    circle.setAttribute('tabindex','-1');
    circle.focus?.({preventScroll:true});
    setStatus(`Highlighted ${key}.`);
  }

  function togglePlacing(){
    placing = !placing;
    placeBtn.textContent = placing ? 'Placing… (click on map)' : 'Place mode';
    svg.classList.toggle('placing', placing);
  }

  function onSvgClick(evt){
    if (!placing) return;
    const key = sanitizeNumber(bnum.value);
    if (!key){ setStatus('Enter a valid number first (e.g., 1, 12, 14A).', true); return; }

    const id = 'marker-' + key;
    if (svg.querySelector('#'+CSS.escape(id))){ setStatus(`Marker ${key} already exists. Undo or choose another.`, true); return; }

    const { x, y } = clientToSvg(evt);
    // Optional: ensure click was inside actual image area (0..W, 0..H)
    const vb = svg.viewBox.baseVal;
    if (x < 0 || y < 0 || x > vb.width || y > vb.height){
      setStatus('Click was outside the image area. Try again inside the map.', true);
      return;
    }

    createMarker(id, x, y);
    rippleAt(x, y);
    lastPlaced = svg.querySelector('#'+CSS.escape(id));
    placed.push({ id, x, y, r:18 });
    setStatus(`Placed ${key} at (${x.toFixed(0)}, ${y.toFixed(0)}).`);
  }

  function undoLast(){
    if (!lastPlaced) return;
    const id = lastPlaced.getAttribute('id');
    lastPlaced.remove();
    const i = placed.findIndex(m => m.id === id);
    if (i >= 0) placed.splice(i, 1);
    lastPlaced = null;
    setStatus(`Removed ${id}.`);
  }

  function download(name, text, type='text/plain'){
    const blob = new Blob([text], {type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function downloadOverlaySvg(){
    const vb = svg.viewBox.baseVal;
    const inner = Array.from(markersG.children).map(n => n.outerHTML).join('\n');
    const file = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${vb.width} ${vb.height}">\n${inner}\n</svg>`;
    download('loras-campus-overlay.svg', file, 'image/svg+xml');
    setStatus('Downloaded overlay SVG.');
  }

  function downloadMappingJson(){
    const obj = {};
    for (const m of placed){
      obj[m.id] = { x: +m.x.toFixed(2), y: +m.y.toFixed(2), r: m.r };
    }
    download('overlay-mapping.json', JSON.stringify(obj, null, 2), 'application/json');
    setStatus('Downloaded mapping.json.');
  }

  // Wire up UI
  goBtn.addEventListener('click', () => highlight(bnum.value));
  bnum.addEventListener('keydown', e => { if (e.key === 'Enter') highlight(bnum.value); });
  clearBtn.addEventListener('click', () => { bnum.value=''; clearHighlights(); });
  placeBtn.addEventListener('click', togglePlacing);
  undoBtn.addEventListener('click', undoLast);
  svg.addEventListener('click', onSvgClick);
  dlSvgBtn.addEventListener('click', downloadOverlaySvg);
  dlJsonBtn.addEventListener('click', downloadMappingJson);
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && placing) togglePlacing(); });

  // --- Embed the image inside the SVG coordinate space ---
  // We first load map.png using an HTML Image to read natural W/H,
  // then set the SVG viewBox and the <image> width/height to match.
  function loadEmbeddedImage(){
    const usp = new URLSearchParams(location.search);
    const src = usp.get('img') ? usp.get('img').trim() : 'map.png';
    const probe = new Image();
    probe.onload = () => {
      // Set the SVG coordinate space to image pixels
      svg.setAttribute('viewBox', `0 0 ${probe.naturalWidth} ${probe.naturalHeight}`);
      img.setAttribute('width',  String(probe.naturalWidth));
      img.setAttribute('height', String(probe.naturalHeight));
      img.setAttribute('href', src);
      setStatus(`Loaded ${src} (${probe.naturalWidth}×${probe.naturalHeight}). You can place markers now.`);
      // Auto-highlight if URL param present
      const initial = usp.get('b') || usp.get('building');
      if (initial) { bnum.value = String(initial).toUpperCase(); }
    };
    probe.onerror = () => {
      setStatus(`Could not load ${src}. Make sure it sits next to this HTML.`, true);
    };
    probe.src = src + (src.includes('?') ? '&' : '?') + 'v=' + Date.now(); // cache-bust
  }

  loadEmbeddedImage();
})();
</script>

</body>
</html>